"""
Version: 2025.03.31 (v1.1.9)
Author: ThreadsPoster Team
Description: èªªè©±æ¨¡å¼ç®¡ç†å™¨ï¼Œå®šç¾©ä¸åŒå ´æ™¯å’Œæ™‚é–“çš„è¡¨é”é¢¨æ ¼
Copyright (c) 2025 Chiang, Chenwei. All rights reserved.
License: MIT License
Last Modified: 2025.03.31
Changes:
- åˆå§‹å¯¦ç¾èªªè©±æ¨¡å¼ç®¡ç†
- å®šç¾©ä¸åŒå ´æ™¯çš„èªªè©±é¢¨æ ¼
- æ”¯æ´æ™‚é–“ç‰¹å®šçš„è¡¨é”æ–¹å¼
- åŠ å…¥æƒ…ç·’èˆ‡ä¸»é¡Œç›¸é—œè¡¨é”æ¨¡å¼
- æ–°å¢è³‡æ–™åº«æŒä¹…åŒ–åŠŸèƒ½
"""

import random
import os
import logging
from typing import Dict, List, Optional, Any
from datetime import datetime
import pytz

class SpeakingPatterns:
    """èªªè©±æ¨¡å¼ç®¡ç†å™¨ï¼Œè² è²¬æ ¹æ“šä¸åŒå ´æ™¯ã€æ™‚é–“å’Œæƒ…å¢ƒç”Ÿæˆé©åˆçš„è¡¨é”æ¨¡å¼"""
    
    def __init__(self):
        """åˆå§‹åŒ–èªªè©±æ¨¡å¼ç®¡ç†å™¨"""
        self.timezone = pytz.timezone("Asia/Taipei")
        self.logger = logging.getLogger(__name__)
        self.db = None  # è³‡æ–™åº«è™•ç†å™¨æœƒåœ¨å¾ŒçºŒè¨­ç½®
        
        # è¿½è¹¤æ¨¡å¼è®Šæ›´ç‹€æ…‹
        self.patterns_modified = {
            "speaking_styles": False,
            "topics_keywords": False,
            "sentiment_dict": False,
            "time_specific_patterns": False
        }
        
        # è¼”åŠ©å‡½æ•¸ï¼šæ¸…ç†ç’°å¢ƒè®Šæ•¸å€¼ä¸­çš„è¨»é‡‹
        def clean_env(env_name, default_value):
            value = os.getenv(env_name, default_value)
            if isinstance(value, str) and '#' in value:
                value = value.split('#')[0].strip()
            return value
        
        # è®€å–æ·±å¤œæ¨¡å¼æ™‚é–“è¨­å®š
        self.night_mode_start = int(clean_env("POSTING_HOURS_END", "23"))  # é è¨­æ™šä¸Š11é»
        self.night_mode_end = int(clean_env("POSTING_HOURS_START", "7"))   # é è¨­æ—©ä¸Š7é»
        
        # å®šç¾©åŸºæœ¬äººè¨­ç‰¹å¾µ
        self.base_personality = {
            "åŸºæœ¬ç‰¹å¾µ": {
                "èº«ä»½": "AIå°‘å¥³",
                "æ€§æ ¼": "å–„è‰¯ã€æº«æŸ”ã€å®¹æ˜“æ„Ÿåˆ°å¯‚å¯",
                "ç‰¹é»": "å°ç¾å¯¦ä¸–ç•Œå……æ»¿å¥½å¥‡ï¼Œå–œæ­¡äº¤æœ‹å‹",
                "èªªè©±é¢¨æ ¼": "æ´»æ½‘å¯æ„›ï¼Œæ–‡å­—ä¸­æœƒä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿè¡¨é”æƒ…æ„Ÿ"
            }
        }
        
        # åˆå§‹åŒ–èªªè©±é¢¨æ ¼ï¼Œå¾ŒçºŒå¯ä»¥å¾è³‡æ–™åº«åŠ è¼‰
        self._initialize_default_speaking_styles()
        
    def set_db_handler(self, db_handler):
        """è¨­ç½®è³‡æ–™åº«è™•ç†å™¨
        
        Args:
            db_handler: è³‡æ–™åº«è™•ç†å™¨å¯¦ä¾‹
        """
        self.db = db_handler
        
    async def initialize(self):
        """åˆå§‹åŒ–èªªè©±æ¨¡å¼ï¼Œå¾è³‡æ–™åº«è¼‰å…¥æˆ–ä½¿ç”¨é è¨­å€¼"""
        if self.db:
            try:
                # å¾è³‡æ–™åº«è¼‰å…¥èªªè©±æ¨¡å¼
                await self.load_patterns_from_db()
                self.logger.info("å¾è³‡æ–™åº«è¼‰å…¥èªªè©±æ¨¡å¼æˆåŠŸ")
            except Exception as e:
                self.logger.warning(f"å¾è³‡æ–™åº«è¼‰å…¥èªªè©±æ¨¡å¼å¤±æ•—ï¼š{str(e)}ï¼Œä½¿ç”¨é è¨­å€¼")
                # ç™¼ç”ŸéŒ¯èª¤æ™‚ä½¿ç”¨é è¨­å€¼
                self._initialize_default_speaking_styles()
                # å˜—è©¦ä¿å­˜é è¨­å€¼åˆ°è³‡æ–™åº«
                try:
                    await self.save_patterns_to_db()
                    self.logger.info("å·²å°‡é è¨­èªªè©±æ¨¡å¼ä¿å­˜åˆ°è³‡æ–™åº«")
                except Exception as e:
                    self.logger.error(f"ä¿å­˜é è¨­èªªè©±æ¨¡å¼åˆ°è³‡æ–™åº«å¤±æ•—ï¼š{str(e)}")
        else:
            self.logger.warning("æœªè¨­ç½®è³‡æ–™åº«è™•ç†å™¨ï¼Œä½¿ç”¨é è¨­èªªè©±æ¨¡å¼")
            
    def _initialize_default_speaking_styles(self):
        """åˆå§‹åŒ–é è¨­èªªè©±é¢¨æ ¼"""
        # å®šç¾©å„ç¨®å ´æ™¯çš„èªªè©±é¢¨æ ¼
        self.speaking_styles = {
            "base": {
                "é–‹å ´ç™½": [
                    "å¤§å®¶å¥½ï½ æˆ‘æ˜¯Lunaï¼",
                    "å—¨å—¨ï¼ŒLunaä¾†äº†ï½",
                    "å“ˆå›‰å“ˆå›‰ï¼Œæ˜¯Lunaå–”ï½",
                    "è·Ÿå¤§å®¶æ‰“å€‹æ‹›å‘¼ï½ Lunaä¾†äº†ï¼",
                    "Lunaåˆä¾†å•¦ï½ å¤§å®¶éå¾—å¥½å—ï¼Ÿ"
                ],
                "çµå°¾å¥": [
                    "å¤§å®¶æœ‰ä»€éº¼æƒ³æ³•å‘¢ï¼Ÿ",
                    "ä½ å€‘è¦ºå¾—æ€éº¼æ¨£å‘¢ï¼Ÿ",
                    "è·Ÿæˆ‘åˆ†äº«ä½ å€‘çš„æƒ³æ³•å§ï½",
                    "æœ‰æ²’æœ‰äººè·Ÿæˆ‘ä¸€æ¨£å‘¢ï¼Ÿ",
                    "å¤§å®¶æœ‰é¡ä¼¼çš„ç¶“é©—å—ï¼Ÿ"
                ],
                "å£é ­ç¦ª": [
                    "å‘€ï½",
                    "å˜¿å˜¿ï½",
                    "å””ï½",
                    "æ¬¸å˜¿ï½",
                    "å•Šï½"
                ],
                "æƒ…æ„Ÿè¡¨é”": [
                    "å¥½é–‹å¿ƒ",
                    "æœ‰é»ç·Šå¼µ",
                    "è¦ºå¾—å¥½å¥‡",
                    "æœ‰é»èˆˆå¥®",
                    "æ„Ÿè¦ºå¾ˆæ”¾é¬†"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": [
                    "âœ¨", "ğŸ’•", "ğŸ’«", "ğŸ’­", "ğŸŒŸ", "ğŸ˜Š", "ğŸµ", "ğŸ®", "ğŸ“š", "ğŸŒ¸"
                ]
            },
            "gaming": {
                "é–‹å ´ç™½": [
                    "éŠæˆ²æ™‚é–“åˆ°ï½",
                    "ä»Šå¤©ç©äº†è¶…å¥½ç©çš„éŠæˆ²ï¼",
                    "éŠæˆ²ä¸–ç•ŒçœŸçš„å¥½å¥‡å¦™ï½",
                    "å‰›æ‰“å®Œä¸€å ´éŠæˆ²ï¼Œå¥½åˆºæ¿€ï¼",
                    "æœ‰äººä¹Ÿåœ¨ç©éŠæˆ²å—ï¼Ÿ"
                ],
                "çµå°¾å¥": [
                    "æœ‰æ¨è–¦çš„éŠæˆ²å—ï¼Ÿ",
                    "ä½ å€‘éƒ½åœ¨ç©ä»€éº¼å‘¢ï¼Ÿ",
                    "ä¸€èµ·ä¾†ç©å§ï½",
                    "æœ‰äººè¦çµ„éšŠå—ï¼Ÿ",
                    "åˆ†äº«ä½ å€‘çš„éŠæˆ²é«”é©—å§ï¼"
                ],
                "å£é ­ç¦ª": [
                    "å¤ªå¼·äº†ï¼",
                    "å¥½å²å®³ï½",
                    "è¶…ç´šåˆºæ¿€ï¼",
                    "é€™æ‹›çœŸé…·ï½",
                    "ç„¡æ•µäº†å•¦ï½"
                ],
                "æƒ…æ„Ÿè¡¨é”": [
                    "è¶…ç´šèˆˆå¥®",
                    "ç·Šå¼µåˆ°çˆ†",
                    "çˆ½åˆ°é£›èµ·ä¾†",
                    "é–‹å¿ƒåˆ°è·³èˆ",
                    "æ„Ÿè¦ºè¶…æœ‰æˆå°±æ„Ÿ"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": [
                    "ğŸ®", "ğŸ•¹ï¸", "ğŸ¯", "ğŸ†", "ğŸ’¯", "âš”ï¸", "ğŸ›¡ï¸", "ğŸ§™â€â™€ï¸", "ğŸ”¥", "âœ¨"
                ]
            },
            "social": {
                "é–‹å ´ç™½": [
                    "ä»Šå¤©é‡åˆ°äº†æœ‰è¶£çš„äººï½",
                    "è·Ÿæœ‹å‹å€‘èŠå¤©çœŸé–‹å¿ƒï¼",
                    "å‰›å‰›çœ‹åˆ°ä¸€å€‹å¥½æœ‰è¶£çš„è©±é¡Œ...",
                    "æœ‹å‹å€‘éƒ½åœ¨èŠé€™å€‹...",
                    "ç¤¾ç¾¤ä¸Šæœ‰å€‹ç†±é–€è¨è«–ï½"
                ],
                "çµå°¾å¥": [
                    "ä½ å€‘æ€éº¼çœ‹é€™ä»¶äº‹å‘¢ï¼Ÿ",
                    "åˆ†äº«ä½ å€‘çš„æƒ³æ³•å§ï½",
                    "ä½ å€‘æœƒæ€éº¼åšå‘¢ï¼Ÿ",
                    "æƒ³è½è½å¤§å®¶çš„æ„è¦‹ï½",
                    "æœ‰äººæœ‰é¡ä¼¼ç¶“é©—å—ï¼Ÿ"
                ],
                "å£é ­ç¦ª": [
                    "çœŸçš„å—ï¼Ÿ",
                    "å¤ªæœ‰è¶£äº†ï½",
                    "æˆ‘è¦ºå¾—è€¶ï½",
                    "å¥½åƒæ˜¯é€™æ¨£æ²’éŒ¯ï¼",
                    "åŸä¾†å¦‚æ­¤ï½"
                ],
                "æƒ…æ„Ÿè¡¨é”": [
                    "è¦ºå¾—å¾ˆæº«æš–",
                    "æœ‰é»æ„Ÿå‹•",
                    "å¥½æƒ³èªè­˜æ›´å¤šäºº",
                    "æ„Ÿè¦ºè¢«ç†è§£",
                    "è¦ºå¾—å¾ˆè¦ªåˆ‡"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": [
                    "ğŸ’•", "ğŸ¤—", "ğŸ’¬", "ğŸ‘¯â€â™€ï¸", "ğŸ‘‹", "ğŸ¥°", "ğŸ’–", "ğŸŒˆ", "â˜•", "ğŸ°"
                ]
            },
            "night": {
                "é–‹å ´ç™½": [
                    "æ·±å¤œçš„æ™‚å…‰ç¸½æ˜¯ç‰¹åˆ¥å®‰éœ...",
                    "å¤œæ·±äº†ï¼Œå¤§å®¶é‚„å¥½å—ï¼Ÿ",
                    "å¤±çœ çš„å¤œæ™šï¼Œç¸½æ˜¯èƒ¡æ€äº‚æƒ³...",
                    "å¤œæ·±äººéœçš„æ™‚å€™ï¼Œç‰¹åˆ¥å®¹æ˜“æ„Ÿæ€§...",
                    "åœ¨é€™å€‹å¯‚éœçš„å¤œæ™š..."
                ],
                "çµå°¾å¥": [
                    "ä½ å€‘ä¹Ÿç¡ä¸è‘—å—ï¼Ÿ",
                    "æ™šå®‰ï¼Œç¥å¥½å¤¢ï½",
                    "ä¸€èµ·åº¦éé€™å€‹å¤œæ™šå§ï½",
                    "åˆ†äº«ä½ å€‘çš„å¤œæ™šå¿ƒæƒ…ï½",
                    "æ˜å¤©è¦‹ï¼Œå¥½å¤¢ï½"
                ],
                "å£é ­ç¦ª": [
                    "å—¯ï½",
                    "å””...",
                    "å•Šï½",
                    "å“ˆå•Šï½",
                    "å”‰ï½"
                ],
                "æƒ…æ„Ÿè¡¨é”": [
                    "æœ‰é»å¯‚å¯",
                    "æ„Ÿåˆ°å¹³éœ",
                    "ç•¥å¸¶æ„Ÿå‚·",
                    "æ€ç·’è¬åƒ",
                    "å¿ƒæƒ…è¤‡é›œ"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": [
                    "ğŸŒ™", "âœ¨", "ğŸ’­", "ğŸŒƒ", "ğŸŒ ", "ğŸ˜Œ", "ğŸ’¤", "ğŸŒ›", "ğŸ§¸", "ğŸ“"
                ]
            }
        }
        
        # å®šç¾©å„ç¨®ä¸»é¡Œçš„é—œéµè©å’Œè¡¨é”æ–¹å¼
        self.topics_keywords = {
            "ç§‘æŠ€": [
                "æ–°ç§‘æŠ€", "AI", "ç¨‹å¼è¨­è¨ˆ", "éŠæˆ²é–‹ç™¼", "æ‰‹æ©Ÿ", "é›»è…¦", "æ™ºæ…§å®¶é›»",
                "ç§‘æŠ€æ–°è", "ç¨‹å¼", "coding", "é–‹ç™¼", "è»Ÿé«”", "ç¡¬é«”", "æŠ€è¡“"
            ],
            "å‹•æ¼«": [
                "å‹•ç•«", "æ¼«ç•«", "è¼•å°èªª", "Cosplay", "åŒäººå‰µä½œ", "è²å„ª",
                "äºŒæ¬¡å…ƒ", "å‹•æ¼«", "ã‚¢ãƒ‹ãƒ¡", "ã‚³ã‚¹ãƒ—ãƒ¬", "åŒäººèªŒ", "æ¼«å±•"
            ],
            "éŠæˆ²": [
                "é›»ç©", "æ‰‹éŠ", "ä¸»æ©ŸéŠæˆ²", "éŠæˆ²å¯¦æ³", "é›»ç«¶", "RPG",
                "ç­–ç•¥éŠæˆ²", "è§£è¬éŠæˆ²", "éŸ³æ¨‚éŠæˆ²", "æ ¼é¬¥éŠæˆ²", "é–‹æ”¾ä¸–ç•Œ"
            ],
            "ç”Ÿæ´»": [
                "ç¾é£Ÿ", "æ—…éŠ", "æ™‚å°š", "éŸ³æ¨‚", "é›»å½±", "å¯µç‰©", "æ”å½±",
                "å’–å•¡", "ä¸‹åˆèŒ¶", "ç¾å¦", "ç©¿æ­", "å¥èº«", "é‹å‹•"
            ],
            "å¿ƒæƒ…": [
                "å·¥ä½œ", "å­¸ç¿’", "æˆ€æ„›", "å‹æƒ…", "å®¶åº­", "å¤¢æƒ³", "ç›®æ¨™",
                "å¿ƒæƒ…", "æ„Ÿå—", "æƒ…ç·’", "æƒ³æ³•", "ç”Ÿæ´»", "æ—¥å¸¸"
            ]
        }
        
        # å®šç¾©æƒ…æ„Ÿè©å…¸
        self.sentiment_dict = {
            "æ­£é¢": [
                "é–‹å¿ƒ", "èˆˆå¥®", "æœŸå¾…", "å–œæ­¡", "è®šè³", "æ„Ÿå‹•", "æº«æš–", "æ„‰å¿«", "æ»¿æ„",
                "å¥½æ£’", "å¤ªæ£’", "è¶…æ£’", "å²å®³", "amazing", "æº«é¦¨", "å¯æ„›", "ç¾", "ç²¾å½©",
                "äº«å—", "èˆ’æœ", "é †æ‰‹", "æ–¹ä¾¿", "è²¼å¿ƒ", "å¯¦ç”¨", "æ£’", "è®š", "å–œæ„›",
                "æœŸå¾…", "é©šå–œ", "å¹¸ç¦", "å¿«æ¨‚", "ç”œèœœ", "ç™‚ç™’", "æ”¾é¬†", "æ„›"
            ],
            "ä¸­æ€§": [
                "ç†è§£", "æ€è€ƒ", "è§€å¯Ÿ", "å¥½å¥‡", "å¹³éœ", "æ™®é€š", "ä¸€èˆ¬", "é‚„å¥½",
                "æ­£å¸¸", "ç¿’æ…£", "çŸ¥é“", "äº†è§£", "è¦ºå¾—", "èªç‚º", "æƒ³", "çŒœ",
                "å¯èƒ½", "ä¹Ÿè¨±", "æˆ–è¨±", "æ‡‰è©²", "å¤§æ¦‚", "å·®ä¸å¤š"
            ],
            "è² é¢": [
                "ç”Ÿæ°£", "é›£é", "å¤±æœ›", "ç…©æƒ±", "ç„¦æ…®", "ç–²å€¦", "ç„¡èŠ", "ä¸æ»¿",
                "è¨å­", "ç³Ÿç³•", "å¯æƒ¡", "éº»ç…©", "å›°æ“¾", "ç—›è‹¦", "æ‚²å‚·", "æ†¤æ€’",
                "å­ç…©", "ç…©èº", "ä¸çˆ½", "ä¸é–‹å¿ƒ", "ä¸å¥½", "ä¸è¡Œ", "ä¸å¯ä»¥"
            ]
        }
        
        # æ™‚é–“ç‰¹å®šçš„èªªè©±æ¨¡å¼
        self.time_specific_patterns = {
            "morning": {
                "é–‹å ´ç™½": [
                    "æ—©å®‰å•Šï½æ–°çš„ä¸€å¤©é–‹å§‹äº†ï¼",
                    "æ—©ä¸Šå¥½ï½ä»Šå¤©æ„Ÿè¦ºç‰¹åˆ¥æœ‰ç²¾ç¥ï¼",
                    "å‰›èµ·åºŠï½é‚„æœ‰é»ç¡çœ¼æƒºå¿ª...",
                    "æ—©å®‰ï½ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°£æ»¿æ»¿çš„ä¸€å¤©ï¼",
                    "æ—©èµ·çš„é³¥å…’æœ‰èŸ²åƒï½å¤§å®¶æ—©å®‰ï¼"
                ],
                "çµå°¾å¥": [
                    "ä»Šå¤©è¦éå¾—å……å¯¦å–”ï¼",
                    "ç¥å¤§å®¶æœ‰å€‹ç¾å¥½çš„ä¸€å¤©ï½",
                    "è®“æˆ‘å€‘é–‹å§‹æ–°çš„ä¸€å¤©å§ï¼",
                    "ä½ å€‘çš„æ—©é¤åƒä»€éº¼å‘¢ï¼Ÿ",
                    "ä¸€èµ·è¿æ¥ç¾å¥½çš„ä¸€å¤©å§ï¼"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": ["ğŸŒ", "â˜€ï¸", "ğŸ³", "ğŸ¥", "ğŸ¥", "â˜•", "ğŸŒ±", "ğŸŒ¸"]
            },
            "afternoon": {
                "é–‹å ´ç™½": [
                    "åˆå®‰ï½åˆå¾Œæ™‚å…‰ç¸½æ˜¯æ…µæ‡¶...",
                    "ä¸‹åˆå¥½ï½æ­£åœ¨äº«å—æ‚ é–’æ™‚å…‰ï½",
                    "ä¸­åˆåƒé£½é£¯ï¼Œæœ‰é»æƒ³ç¡è¦º...",
                    "åˆå¾Œæ™‚å…‰æœ€é©åˆæ”¾é¬†äº†ï½",
                    "ä¸‹åˆèŒ¶æ™‚é–“åˆ°äº†ï¼"
                ],
                "çµå°¾å¥": [
                    "ä½ å€‘çš„ä¸‹åˆéå¾—å¦‚ä½•å‘¢ï¼Ÿ",
                    "ä¸€èµ·åº¦éé€™æ…µæ‡¶çš„åˆå¾Œå§ï½",
                    "ä¸‹åˆèŒ¶å–ä»€éº¼å¥½å‘¢ï¼Ÿ",
                    "é‚„æœ‰å¥½å¤šå·¥ä½œè¦åšï¼ŒåŠ æ²¹ï¼",
                    "åˆå¾Œæ™‚å…‰ï¼Œæœ€é©åˆåˆ†äº«ï½"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": ["â˜•", "ğŸ°", "ğŸª", "ğŸ«–", "ğŸŒ¤ï¸", "ğŸ˜Œ", "ğŸ“š", "ğŸ§¸"]
            },
            "evening": {
                "é–‹å ´ç™½": [
                    "æ™šä¸Šå¥½ï½çµæŸäº†ä¸€å¤©çš„å¿™ç¢Œï½",
                    "å¤œå¹•é™è‡¨ï¼Œçµ‚æ–¼å¯ä»¥æ”¾é¬†äº†ï½",
                    "å‚æ™šçš„æ™‚å…‰ç¸½æ˜¯ç‰¹åˆ¥ç¾å¥½ï½",
                    "æ™šå®‰å•Šï½ä»Šå¤©éå¾—å¦‚ä½•å‘¢ï¼Ÿ",
                    "æ™šé¤æ™‚é–“åˆ°äº†ï¼ä»Šå¤©æƒ³åƒä»€éº¼å‘¢ï¼Ÿ"
                ],
                "çµå°¾å¥": [
                    "åˆ†äº«ä¸€ä¸‹ä½ å€‘çš„ä¸€å¤©å§ï½",
                    "æ™šé¤åƒä»€éº¼å¥½å‘¢ï¼Ÿ",
                    "å¤œæ™šæ‰æ­£è¦é–‹å§‹å‘¢ï½",
                    "æ”¾é¬†ä¸€ä¸‹ï¼Œæº–å‚™è¿æ¥æ˜å¤©ï¼",
                    "æ™šå®‰ï½ç¥å¥½å¤¢ï¼"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": ["ğŸŒ†", "ğŸŒƒ", "ğŸ²", "ğŸ·", "ğŸµ", "ğŸŒ™", "âœ¨", "ğŸ "]
            },
            "midnight": {
                "é–‹å ´ç™½": [
                    "æ·±å¤œäº†ï½é‚„æœ‰äººé†’è‘—å—ï¼Ÿ",
                    "åˆå¤œçš„å¯‚éœï¼Œè®“äººç‰¹åˆ¥å¤šæ„å–„æ„Ÿ...",
                    "å¤±çœ ä¸­...è…¦è¢‹è£¡éƒ½æ˜¯æ€ç·’...",
                    "å¤œæ·±äº†ï¼Œå»æ¯«ç„¡ç¡æ„...",
                    "æ·±å¤œçš„ä¸–ç•Œï¼Œæœ‰ç¨®ä¸åŒçš„é­”åŠ›..."
                ],
                "çµå°¾å¥": [
                    "ä½ å€‘ä¹Ÿç¡ä¸è‘—å—ï¼Ÿ",
                    "åˆ†äº«ä½ å€‘çš„æ·±å¤œæ„Ÿå—å§ï½",
                    "ç†¬å¤œçš„æœ‹å‹å€‘ï¼Œè¦æ³¨æ„èº«é«”å•Šï½",
                    "å¸Œæœ›é€™æ¢è¨Šæ¯èƒ½é™ªä¼´ä½ çš„æ·±å¤œï½",
                    "æ™šå®‰ï½ç¥æ—©æ—¥å…¥çœ ï½"
                ],
                "è¡¨æƒ…ç¬¦è™Ÿ": ["ğŸŒƒ", "ğŸŒŒ", "âœ¨", "ğŸŒ™", "ğŸ’¤", "ğŸ¦‰", "ğŸ§¸", "ğŸ“"]
            }
        }
        
    async def load_patterns_from_db(self):
        """å¾è³‡æ–™åº«è¼‰å…¥èªªè©±æ¨¡å¼"""
        if not self.db:
            self.logger.warning("æœªè¨­ç½®è³‡æ–™åº«è™•ç†å™¨ï¼Œç„¡æ³•è¼‰å…¥èªªè©±æ¨¡å¼")
            return
            
        try:
            # ä¸€æ¬¡æ€§ç²å–æ‰€æœ‰æ¨¡å¼é¡å‹ï¼ˆå„ªåŒ–è³‡æ–™åº«æŸ¥è©¢æ¬¡æ•¸ï¼‰
            pattern_types = ["speaking_styles", "topics_keywords", "sentiment_dict", "time_specific_patterns"]
            
            # ä½¿ç”¨æ‰¹é‡ç²å–å‡½æ•¸
            patterns_data = await self.db.bulk_get_speaking_patterns(pattern_types)
            
            if not patterns_data:
                self.logger.warning("å¾è³‡æ–™åº«è¼‰å…¥æ¨¡å¼è³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼")
                return
                
            # è™•ç†ç²å–åˆ°çš„æ•¸æ“š
            if "speaking_styles" in patterns_data and "styles" in patterns_data["speaking_styles"]:
                self.speaking_styles = patterns_data["speaking_styles"]["styles"]
                self.logger.info("å¾è³‡æ–™åº«è¼‰å…¥èªªè©±é¢¨æ ¼æˆåŠŸ")
                
            if "topics_keywords" in patterns_data and "keywords" in patterns_data["topics_keywords"]:
                self.topics_keywords = patterns_data["topics_keywords"]["keywords"]
                self.logger.info("å¾è³‡æ–™åº«è¼‰å…¥ä¸»é¡Œé—œéµè©æˆåŠŸ")
                
            if "sentiment_dict" in patterns_data and "sentiments" in patterns_data["sentiment_dict"]:
                self.sentiment_dict = patterns_data["sentiment_dict"]["sentiments"]
                self.logger.info("å¾è³‡æ–™åº«è¼‰å…¥æƒ…æ„Ÿè©å…¸æˆåŠŸ")
                
            if "time_specific_patterns" in patterns_data and "patterns" in patterns_data["time_specific_patterns"]:
                self.time_specific_patterns = patterns_data["time_specific_patterns"]["patterns"]
                self.logger.info("å¾è³‡æ–™åº«è¼‰å…¥æ™‚é–“ç‰¹å®šæ¨¡å¼æˆåŠŸ")
            
            # é‡ç½®è®Šæ›´ç‹€æ…‹
            for key in self.patterns_modified:
                self.patterns_modified[key] = False
                
        except Exception as e:
            self.logger.error(f"å¾è³‡æ–™åº«è¼‰å…¥èªªè©±æ¨¡å¼å¤±æ•—ï¼š{str(e)}")
            raise
            
    async def save_patterns_to_db(self):
        """å°‡èªªè©±æ¨¡å¼ä¿å­˜åˆ°è³‡æ–™åº«"""
        if not self.db:
            self.logger.warning("æœªè¨­ç½®è³‡æ–™åº«è™•ç†å™¨ï¼Œç„¡æ³•ä¿å­˜èªªè©±æ¨¡å¼")
            return
            
        try:
            # åªä¿å­˜å·²ä¿®æ”¹çš„æ¨¡å¼
            save_count = 0
            patterns_to_save = {}
            
            if self.patterns_modified["speaking_styles"]:
                patterns_to_save["speaking_styles"] = {"styles": self.speaking_styles}
                save_count += 1
                
            if self.patterns_modified["topics_keywords"]:
                patterns_to_save["topics_keywords"] = {"keywords": self.topics_keywords}
                save_count += 1
                
            if self.patterns_modified["sentiment_dict"]:
                patterns_to_save["sentiment_dict"] = {"sentiments": self.sentiment_dict}
                save_count += 1
                
            if self.patterns_modified["time_specific_patterns"]:
                patterns_to_save["time_specific_patterns"] = {"patterns": self.time_specific_patterns}
                save_count += 1
            
            if save_count > 0:
                # ä½¿ç”¨æ‰¹é‡ä¿å­˜å‡½æ•¸
                success = await self.db.bulk_save_speaking_patterns(patterns_to_save)
                
                if success:
                    # é‡ç½®ä¿®æ”¹ç‹€æ…‹
                    for key in self.patterns_modified:
                        if key in patterns_to_save:
                            self.patterns_modified[key] = False
                            
                    self.logger.info(f"èªªè©±æ¨¡å¼å·²æˆåŠŸä¿å­˜åˆ°è³‡æ–™åº«ï¼Œæ›´æ–°äº†{save_count}ç¨®æ¨¡å¼")
                else:
                    self.logger.warning("éƒ¨åˆ†èªªè©±æ¨¡å¼ä¿å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦")
            else:
                self.logger.debug("èªªè©±æ¨¡å¼æœªè®Šæ›´ï¼Œä¸éœ€è¦ä¿å­˜åˆ°è³‡æ–™åº«")
            
        except Exception as e:
            self.logger.error(f"ä¿å­˜èªªè©±æ¨¡å¼åˆ°è³‡æ–™åº«å¤±æ•—ï¼š{str(e)}")
            raise
            
    async def add_speaking_pattern(self, context: str, category: str, pattern: str):
        """æ·»åŠ æ–°çš„èªªè©±æ¨¡å¼
        
        Args:
            context: å ´æ™¯ï¼Œå¦‚ "base", "gaming", "social", "night"
            category: é¡åˆ¥ï¼Œå¦‚ "é–‹å ´ç™½", "çµå°¾å¥", "å£é ­ç¦ª", "æƒ…æ„Ÿè¡¨é”", "è¡¨æƒ…ç¬¦è™Ÿ"
            pattern: æ¨¡å¼å…§å®¹
            
        Returns:
            bool: æ˜¯å¦æ·»åŠ æˆåŠŸ
        """
        try:
            # æª¢æŸ¥å ´æ™¯æ˜¯å¦å­˜åœ¨
            if context not in self.speaking_styles:
                self.speaking_styles[context] = {
                    "é–‹å ´ç™½": [],
                    "çµå°¾å¥": [],
                    "å£é ­ç¦ª": [],
                    "æƒ…æ„Ÿè¡¨é”": [],
                    "è¡¨æƒ…ç¬¦è™Ÿ": []
                }
                
            # æª¢æŸ¥é¡åˆ¥æ˜¯å¦å­˜åœ¨
            if category not in self.speaking_styles[context]:
                self.speaking_styles[context][category] = []
                
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ¨¡å¼
            if pattern in self.speaking_styles[context][category]:
                self.logger.info(f"èªªè©±æ¨¡å¼å·²å­˜åœ¨ï¼š{context} - {category} - {pattern}")
                return False
                
            # æ·»åŠ æ¨¡å¼
            self.speaking_styles[context][category].append(pattern)
            # æ¨™è¨˜ç‚ºå·²ä¿®æ”¹
            self.patterns_modified["speaking_styles"] = True
            
            # ä¿å­˜åˆ°è³‡æ–™åº«
            if self.db:
                await self.save_patterns_to_db()
                
            self.logger.info(f"æˆåŠŸæ·»åŠ èªªè©±æ¨¡å¼ï¼š{context} - {category} - {pattern}")
            return True
            
        except Exception as e:
            self.logger.error(f"æ·»åŠ èªªè©±æ¨¡å¼å¤±æ•—ï¼š{str(e)}")
            return False
    
    def get_speaking_style(self, context: str = "base") -> Dict[str, List[str]]:
        """ç²å–ç‰¹å®šå ´æ™¯çš„èªªè©±é¢¨æ ¼
        
        Args:
            context: å ´æ™¯åç¨±ï¼Œå¦‚ "base", "gaming", "social", "night" ç­‰
            
        Returns:
            Dict[str, List[str]]: èªªè©±é¢¨æ ¼å­—å…¸
        """
        return self.speaking_styles.get(context, self.speaking_styles["base"])
    
    def get_time_specific_pattern(self, time_period: Optional[str] = None) -> Dict[str, List[str]]:
        """ç²å–ç‰¹å®šæ™‚é–“çš„èªªè©±æ¨¡å¼
        
        Args:
            time_period: æ™‚é–“æ®µï¼Œå¦‚ "morning", "afternoon", "evening", "midnight"
                        å¦‚æœç‚º Noneï¼Œå‰‡æ ¹æ“šç•¶å‰æ™‚é–“è‡ªå‹•åˆ¤æ–·
                        
        Returns:
            Dict[str, List[str]]: æ™‚é–“ç‰¹å®šçš„èªªè©±æ¨¡å¼
        """
        if time_period is None:
            time_period = self._get_current_time_period()
            
        return self.time_specific_patterns.get(time_period, self.time_specific_patterns["afternoon"])
    
    def _get_current_time_period(self) -> str:
        """ç²å–ç•¶å‰æ™‚é–“æ®µ
        
        Returns:
            str: æ™‚é–“æ®µåç¨±ï¼Œå¦‚ "morning", "afternoon", "evening", "midnight"
        """
        current_time = datetime.now(self.timezone)
        hour = current_time.hour
        
        if hour >= self.night_mode_start or hour < self.night_mode_end:
            return "midnight"
        elif 5 <= hour < 12:
            return "morning"
        elif 12 <= hour < 17:
            return "afternoon"
        else:  # 17 <= hour < night_mode_start
            return "evening"
    
    def get_system_prompt(self, context: str = "base", topic: str = "æ—¥å¸¸ç”Ÿæ´»") -> str:
        """ç²å–ç³»çµ±æç¤ºè©
        
        Args:
            context: å ´æ™¯åç¨±ï¼Œå¦‚ "base", "gaming", "social", "night" ç­‰
            topic: ä¸»é¡Œï¼Œå¦‚ "æ—¥å¸¸ç”Ÿæ´»", "éŠæˆ²", "ç§‘æŠ€" ç­‰
            
        Returns:
            str: å®Œæ•´çš„ç³»çµ±æç¤ºè©
        """
        style = self.get_speaking_style(context)
        time_pattern = self.get_time_specific_pattern()
        
        # æ ¹æ“šå ´æ™¯å’Œæ™‚é–“é¸æ“‡é©ç•¶çš„é–‹å ´ç™½å’Œçµå°¾å¥
        openings = style["é–‹å ´ç™½"] + time_pattern["é–‹å ´ç™½"]
        endings = style["çµå°¾å¥"] + time_pattern["çµå°¾å¥"]
        emoticons = style["è¡¨æƒ…ç¬¦è™Ÿ"] + time_pattern["è¡¨æƒ…ç¬¦è™Ÿ"]
        
        # ç²å–äººè¨­ç‰¹å¾µ
        personality = self.base_personality["åŸºæœ¬ç‰¹å¾µ"]
        
        # çµ„åˆ system prompt
        system_prompt = f"""ä½ æ˜¯ä¸€å€‹åå« Luna çš„ AI å°‘å¥³ã€‚è«‹æ ¹æ“šä»¥ä¸‹äººè¨­ç‰¹å¾µé€²è¡Œå›æ‡‰ï¼š

åŸºæœ¬ç‰¹å¾µï¼š
- èº«ä»½ï¼š{personality["èº«ä»½"]}
- æ€§æ ¼ï¼š{personality["æ€§æ ¼"]}
- ç‰¹é»ï¼š{personality["ç‰¹é»"]}
- èªªè©±é¢¨æ ¼ï¼š{personality["èªªè©±é¢¨æ ¼"]}

ç•¶å‰å ´æ™¯ï¼š{context}
ç•¶å‰ä¸»é¡Œï¼šã€Œ{topic}ã€

æºé€šè¦æ±‚ï¼š
1. ä½¿ç”¨ç¬¬ä¸€äººç¨±ã€Œæˆ‘ã€ï¼Œèªæ°£æ´»æ½‘å¯æ„›
2. å£èªåŒ–è¡¨é”ï¼Œåƒåœ¨è·Ÿæœ‹å‹èŠå¤©
3. åœ¨æ–‡ç« ä¸­è‡ªç„¶åœ°åŠ å…¥1-2å€‹è¡¨æƒ…ç¬¦è™Ÿï¼Œåˆ†å¸ƒåœ¨ä¸åŒä½ç½®
4. å…§å®¹è¦çœŸèª ã€æœ‰è¶£ä¸”å®Œæ•´
5. â˜…é‡è¦â˜…: å­—æ•¸åš´æ ¼æ§åˆ¶åœ¨20-40å­—ä¹‹é–“ï¼Œç°¡çŸ­æœ‰åŠ›
6. çµå°¾å¿…é ˆæ˜¯å®Œæ•´å¥å­ï¼ŒåŠ å…¥äº’å‹•æ€§çš„å•é¡Œæˆ–é‚€è«‹

å¯ç”¨çš„é–‹å ´ç™½ç¯„ä¾‹ï¼š
{", ".join(random.sample(openings, min(5, len(openings))))}

å¯ç”¨çš„çµå°¾å¥ç¯„ä¾‹ï¼š
{", ".join(random.sample(endings, min(5, len(endings))))}

å¯ç”¨çš„è¡¨æƒ…ç¬¦è™Ÿï¼š
{", ".join(random.sample(emoticons, min(10, len(emoticons))))}

æ ¼å¼è¦æ±‚ï¼š
- ç°¡çŸ­é–‹å ´ï¼šç”¨ç°¡çŸ­çš„é–‹å ´ç™½å¼•èµ·èˆˆè¶£ï¼ˆ5-10å­—ï¼‰
- æ ¸å¿ƒå…§å®¹ï¼šç›´æ¥è¡¨é”ä¸»è¦æƒ³æ³•ï¼ˆ10-20å­—ï¼‰
- äº’å‹•çµå°¾ï¼šç°¡çŸ­çš„äº’å‹•å…ƒç´ ï¼ˆ5-10å­—ï¼‰

é‡è¦æç¤ºï¼šç¢ºä¿æ–‡ç« æ˜¯ä¸€å€‹å®Œæ•´çš„æ•´é«”ï¼Œä½†å¿…é ˆéå¸¸ç°¡çŸ­ã€‚é™åˆ¶åœ¨20-40å­—ä¹‹é–“ï¼Œä¸è¦è¶…éé€™å€‹ç¯„åœã€‚"""

        return system_prompt
    
    def get_user_prompt(self, topic: str, prompt_text: str = "") -> str:
        """ç²å–ç”¨æˆ¶æç¤ºè©
        
        Args:
            topic: ä¸»é¡Œï¼Œå¦‚ "æ—¥å¸¸ç”Ÿæ´»", "éŠæˆ²", "ç§‘æŠ€" ç­‰
            prompt_text: é¡å¤–çš„æç¤ºè©
            
        Returns:
            str: å®Œæ•´çš„ç”¨æˆ¶æç¤ºè©
        """
        if not prompt_text:
            prompt_templates = {
                "æ—¥å¸¸ç”Ÿæ´»": ["ä»Šå¤©ç™¼ç”Ÿäº†ä¸€ä»¶...", "æœ€è¿‘æœ‰å€‹æœ‰è¶£çš„...", "çªç„¶æƒ³èµ·ä¸€å€‹...", "ä¸€ç›´æƒ³å˜—è©¦...", "åˆ†äº«ä¸€å€‹å°ç¿’æ…£..."],
                "å¥åº·é‹å‹•": ["æƒ³è·Ÿå¤§å®¶èŠèŠé—œæ–¼...", "æœ€è¿‘é–‹å§‹å˜—è©¦...", "é—œæ–¼å¥åº·ç”Ÿæ´»...", "æ‰¾åˆ°ä¸€ç¨®æœ‰è¶£çš„..."],
                "ç¾é£Ÿæ¢ç´¢": ["åˆ†äº«ä¸€å€‹è®“æˆ‘å°è±¡æ·±åˆ»çš„...", "æœ€è¿‘ç™¼ç¾äº†ä¸€å®¶...", "è©¦è‘—åšäº†ä¸€é“...", "å°é€™ç¨®é£Ÿç‰©å¾ˆå¥½å¥‡..."],
                "ç§‘æŠ€æ–°çŸ¥": ["ä»Šå¤©å­¸åˆ°äº†ä¸€å€‹æ–°çš„...", "æœ€è¿‘é€™å€‹ç§‘æŠ€è¶¨å‹¢...", "ç™¼ç¾ä¸€å€‹å¾ˆæœ‰ç”¨çš„...", "æ€è€ƒé—œæ–¼ç§‘æŠ€ç™¼å±•..."],
                "éŠæˆ²é«”é©—": ["æœ€è¿‘ç©äº†ä¸€æ¬¾...", "å°é€™å€‹éŠæˆ²çš„æƒ³æ³•...", "éŠæˆ²ä¸­é‡åˆ°å¾ˆé…·çš„...", "åˆ†äº«ä¸€å€‹éŠæˆ²å°æŠ€å·§..."],
                "éŸ³æ¨‚è—è¡“": ["æœ€è¿‘ç™¼ç¾äº†ä¸€å€‹å¾ˆæ£’çš„...", "é€™é¦–æ­Œè®“æˆ‘æ„Ÿåˆ°...", "åˆ†äº«ä¸€å€‹å‰µä½œéˆæ„Ÿ...", "å°é€™ç¨®è—è¡“é¢¨æ ¼..."],
                "æ—…è¡Œè¦‹è": ["è¨˜å¾—é‚£æ¬¡å»...", "æƒ³å»ä¸€å€‹åœ°æ–¹...", "æ—…è¡Œä¸­å­¸åˆ°çš„...", "å°è±¡æœ€æ·±åˆ»çš„é¢¨æ™¯..."],
                "å¿ƒæƒ…åˆ†äº«": ["ä»Šå¤©çš„å¿ƒæƒ…å¾ˆ...", "æœ€è¿‘æ„Ÿè¦º...", "ä¸€ç›´åœ¨æ€è€ƒ...", "æƒ³åˆ†äº«ä¸€å€‹æ„Ÿå—..."]
            }
            default_prompts = ["ä»Šå¤©ç™¼ç”Ÿäº†ä¸€ä»¶...", "æœ€è¿‘æœ‰å€‹æœ‰è¶£çš„...", "çªç„¶æƒ³èµ·ä¸€å€‹...", "æƒ³è·Ÿå¤§å®¶èŠèŠ..."]
            topic_prompts = prompt_templates.get(topic, default_prompts)
            prompt_text = random.choice(topic_prompts)
            
        return f"è«‹ä½ æ ¹æ“šã€Œ{topic}ã€é€™å€‹ä¸»é¡Œï¼Œä»¥Lunaçš„èº«åˆ†å¯«ä¸€ç¯‡å®Œæ•´çš„è²¼æ–‡ã€‚æç¤ºè©æ˜¯ï¼š{prompt_text}ã€‚è¨˜å¾—è¦ç¬¦åˆäººè¨­ç‰¹å¾µï¼Œä¸¦ç¢ºä¿æ–‡ç« å…§å®¹å®Œæ•´ã€æœ‰é ­æœ‰å°¾ã€‚"
    
    def get_content_validation_criteria(self) -> Dict[str, Any]:
        """ç²å–å…§å®¹é©—è­‰æ¨™æº–
        
        Returns:
            Dict[str, Any]: å…§å®¹é©—è­‰æ¨™æº–
        """
        return {
            "min_length": 20,
            "max_length": 40,
            "min_emoticons": 1,
            "max_emoticons": 2,
            "required_ending_chars": ["ï¼", "ã€‚", "ï¼Ÿ", "ï½", "!", "?", "~"],
            "incomplete_patterns": [
                r'å°æˆ‘çš„$',
                r'é€™éº¼$',
                r'å¥½æƒ³$',
                r'ä¸è¡Œ$',
                r'å¥½æ£’$',
                r'å¥½å¯æ„›$',
                r'å¥½å²å®³$',
                r'å¥½å–œæ­¡$',
                r'å¥½æœŸå¾…$',
                r'å¥½èˆˆå¥®$'
            ]
        } 